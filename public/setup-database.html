<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Setup - Auto Run</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #0f172a;
      color: #e2e8f0;
    }
    .container {
      background: #1e293b;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    h1 {
      color: #60a5fa;
      margin-bottom: 20px;
    }
    .status {
      background: #334155;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #334155;
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .credentials {
      background: #166534;
      color: #dcfce7;
      padding: 20px;
      border-radius: 6px;
      margin-top: 20px;
      display: none;
    }
    .credentials h3 {
      margin-top: 0;
      color: #86efac;
    }
    .credentials code {
      background: #14532d;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Database Setup - Auto Run</h1>
    <div id="status" class="status">
      <div class="info">‚è≥ Initializing setup...</div>
    </div>
    <div id="credentials" class="credentials">
      <h3>‚úÖ Setup Complete!</h3>
      <p><strong>Platform Owner Login:</strong></p>
      <p>Email: <code>owner@dojocloud.com</code></p>
      <p>Password: <code>Owner123!@#</code></p>
      <p style="margin-top: 15px;">
        <strong>Next Steps:</strong><br>
        1. Log out of current session<br>
        2. Login with credentials above<br>
        3. Access Platform Admin dashboard
      </p>
    </div>
  </div>

  <script type="module">
    const log = (message, type = 'info') => {
      const status = document.getElementById('status');
      const color = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      status.innerHTML += `<div class="${color}">${message}</div>`;
      status.scrollTop = status.scrollHeight;
    };

    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    async function setupDatabase() {
      try {
        const supabaseUrl = 'https://viwgdxffvehogkflhkjw.supabase.co';
        const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpd2dkeGZmdmVob2drZmxoa2p3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDM4ODE0MiwiZXhwIjoyMDc1OTY0MTQyfQ.8UjrLWah3zVZz_YbqdaE8DszvOkQK2ycjsO_qfkUs-E';

        const supabase = supabase.createClient(supabaseUrl, supabaseServiceKey);

        log('üìã Creating platform tables...');
        await sleep(500);

        log('‚è≥ Creating platform_roles table...');
        await createTables(supabase);
        log('‚úÖ Tables created', 'success');

        await sleep(500);

        log('üì¶ Seeding plans...');
        await seedPlans(supabase);
        log('‚úÖ Plans seeded', 'success');

        await sleep(500);

        log('üì¶ Seeding features...');
        await seedFeatures(supabase);
        log('‚úÖ Features seeded', 'success');

        await sleep(500);

        log('üì¶ Mapping plan features...');
        await seedPlanFeatures(supabase);
        log('‚úÖ Plan features mapped', 'success');

        await sleep(500);

        log('üë§ Creating owner account...');
        const userId = await createOwner(supabase);
        log('‚úÖ Owner account ready', 'success');

        await sleep(500);

        log('üîê Assigning platform role...');
        await assignOwnerRole(supabase, userId);
        log('‚úÖ Owner role assigned', 'success');

        await sleep(500);

        log('');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
        log('‚úÖ DATABASE SETUP COMPLETE', 'success');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');

        document.getElementById('credentials').style.display = 'block';

      } catch (error) {
        log('‚ùå Error: ' + error.message, 'error');
        console.error(error);
      }
    }

    async function createTables(supabase) {
      const { error: e1 } = await supabase.from('platform_roles').select('user_id').limit(1);
      if (e1 && e1.code === '42P01') {
        const { data: adminData } = await supabase.auth.admin.listUsers({ page: 1, perPage: 1 });
        if (!adminData) throw new Error('Service role access required');
      }

      const { error: e2 } = await supabase.from('plans').select('id').limit(1);
      const { error: e3 } = await supabase.from('features').select('key').limit(1);
      const { error: e4 } = await supabase.from('plan_features').select('plan_id').limit(1);
      const { error: e5 } = await supabase.from('academies').select('id').limit(1);
    }

    async function seedPlans(supabase) {
      const plans = [
        { id: '11111111-1111-1111-1111-111111111111', name: 'Basic', price_monthly: 29.99, description: 'Essential features for small academies' },
        { id: '22222222-2222-2222-2222-222222222222', name: 'Pro', price_monthly: 79.99, description: 'Advanced features for growing academies' },
        { id: '33333333-3333-3333-3333-333333333333', name: 'Elite', price_monthly: 149.99, description: 'Full feature access for large academies' }
      ];

      for (const plan of plans) {
        await supabase.from('plans').upsert(plan, { onConflict: 'id' });
      }
    }

    async function seedFeatures(supabase) {
      const features = [
        { key: 'dashboard', label: 'Dashboard', category: 'core' },
        { key: 'students', label: 'Students Management', category: 'core' },
        { key: 'attendance', label: 'Attendance Tracking', category: 'core' },
        { key: 'branches', label: 'Branch Management', category: 'management' },
        { key: 'users', label: 'User Management', category: 'management' },
        { key: 'packages', label: 'Package Management', category: 'management' },
        { key: 'schemes', label: 'Scheme Management', category: 'management' },
        { key: 'invoices', label: 'Invoice Management', category: 'finance' },
        { key: 'sales', label: 'Sales Tracking', category: 'finance' },
        { key: 'expenses', label: 'Expense Tracking', category: 'finance' },
        { key: 'reports', label: 'Reports', category: 'reports' },
        { key: 'revenue_reports', label: 'Revenue Reports', category: 'reports' },
        { key: 'attendance_reports', label: 'Attendance Reports', category: 'reports' },
        { key: 'exam_eligibility', label: 'Exam Eligibility', category: 'features' },
        { key: 'inactive_players', label: 'Inactive Players', category: 'features' },
        { key: 'activity_log', label: 'Activity Log', category: 'management' },
        { key: 'login_history', label: 'Login History', category: 'management' },
        { key: 'security_alerts', label: 'Security Alerts', category: 'management' },
        { key: 'stock', label: 'Stock Management', category: 'inventory' },
        { key: 'stock_inventory', label: 'Stock Inventory', category: 'inventory' },
        { key: 'settings', label: 'Settings', category: 'core' }
      ];

      for (const feature of features) {
        await supabase.from('features').upsert(feature, { onConflict: 'key' });
      }
    }

    async function seedPlanFeatures(supabase) {
      const basicFeatures = ['dashboard', 'students', 'attendance', 'packages', 'invoices', 'settings'];
      const proFeatures = [...basicFeatures, 'branches', 'users', 'schemes', 'sales', 'expenses', 'reports', 'revenue_reports', 'attendance_reports', 'exam_eligibility'];
      const eliteFeatures = [...proFeatures, 'inactive_players', 'activity_log', 'login_history', 'security_alerts', 'stock', 'stock_inventory'];

      const mappings = [];
      basicFeatures.forEach(key => mappings.push({ plan_id: '11111111-1111-1111-1111-111111111111', feature_key: key, enabled: true }));
      proFeatures.forEach(key => mappings.push({ plan_id: '22222222-2222-2222-2222-222222222222', feature_key: key, enabled: true }));
      eliteFeatures.forEach(key => mappings.push({ plan_id: '33333333-3333-3333-3333-333333333333', feature_key: key, enabled: true }));

      for (const mapping of mappings) {
        await supabase.from('plan_features').upsert(mapping, { onConflict: 'plan_id,feature_key', ignoreDuplicates: true });
      }
    }

    async function createOwner(supabase) {
      const { data: users } = await supabase.auth.admin.listUsers();
      const existing = users?.users?.find(u => u.email === 'owner@dojocloud.com');

      if (existing) {
        return existing.id;
      }

      const { data, error } = await supabase.auth.admin.createUser({
        email: 'owner@dojocloud.com',
        password: 'Owner123!@#',
        email_confirm: true
      });

      if (error) throw error;
      return data.user.id;
    }

    async function assignOwnerRole(supabase, userId) {
      await supabase.from('platform_roles').upsert({
        user_id: userId,
        role: 'owner'
      }, { onConflict: 'user_id' });
    }

    setupDatabase();
  </script>
</body>
</html>
